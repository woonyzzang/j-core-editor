<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="description" content="WYSIWYG Online Editor Web Application">
<meta name="author" content="woonyzzang">
<title>J Editor</title>
<link rel="stylesheet" href="./css/libs/material-icons-3.0.1.min.css">
<link rel="stylesheet" href="./css/libs/codemirror-5.41.0.min.css">
<link rel="stylesheet" href="./css/libs/theme/monokai-5.41.0.min.css"><!-- 테마 -->
<link rel="stylesheet" href="./css/libs/addon/scroll/simplescrollbars.css"><!-- 스크롤바 -->
<link rel="stylesheet" href="./css/libs/addon/hint/show-hint-5.41.0.min.css"><!-- 자동완성 -->
<link rel="stylesheet" href="./css/j-editor.css">
</head>
<body>
<div id="wrap">
    <header>
        <h1><a href="#">J Editor</a></h1>
        <div class="actions">
            <button type="button" title="Shortcut: Command/Ctrl + Enter" id="btnRun" class="btn btn_run"><i class="material-icons">play_arrow</i><span>Run</span></button>
            <div class="combobox">
                <i class="material-icons">list</i>
                <label for="component">Component</label>
                <select id="component">
                    <!--<option value="none">none</option>
                    <option value="accodian">Accodian</option>
                    <option value="menu">Menu</option>
                    <option value="layerPopup">LayerPopup</option>
                    <option value="rollingSlider">RollingSlider</option>
                    <option value="selectbox">Selectbox</option>
                    <option value="tabMemu">TabMenu</option>
                    <option value="tooltip">Tooltip</option>-->
                </select>
            </div>
        </div>
        <div id="controls" class="controls">
            <button type="button" class="btn active">HTML</button>
            <button type="button" class="btn active">CSS</button>
            <button type="button" class="btn active">JavaScript</button>
            <button type="button" class="btn active">Output</button>
        </div>
        <div id="utils" class="utils">
            <a href="#lyPopEditorSettings" title="Editor Settings" data-popover-trigger="editor_settings" id="btnSettings"><i class="material-icons">settings</i><span>Settings</span></a>
            <a href="#lyPopEditorHelp" title="Editor Help" data-popover-trigger="editor_help" id="btnHelp">Help</a>
        </div>
    </header>
    <!-- container -->
    <div id="container">
        <!-- content -->
        <div id="content">
            <main>
                <div id="splitter" class="splitter">
                    <article id="panelHtml" class="panel">
                        <h1>HTML</h1>
                        <div class="editbox">
                            <textarea aria-label="HTML Code Panel" spellcheck="false" autocapitalize="none" autocorrect="off" id="html"></textarea>
                        </div>
                    </article>
                    <article id="panelCss" class="panel">
                        <h1>CSS</h1>
                        <div class="editbox">
                            <textarea aria-label="CSS Code Panel" spellcheck="false" autocapitalize="none" autocorrect="off" id="css"></textarea>
                        </div>
                    </article>
                    <article id="panelJavascript" class="panel">
                        <h1>JavsScript</h1>
                        <div class="editbox">
                            <textarea aria-label="JavaScript Code Pane" spellcheck="false" autocapitalize="none" autocorrect="off" id="javascript"></textarea>
                        </div>
                    </article>
                    <div id="panelOutput" class="panel">
                        <strong>Output</strong>
                        <div class="previewbox">
                            <!-- allow="midi; geolocation; microphone; camera; encrypted-media;" sandbox="allow-forms allow-scripts allow-same-origin allow-modals allow-popups" -->
                            <iframe frameborder="0" allow="midi; geolocation; microphone; camera; encrypted-media;" sandbox="allow-forms allow-scripts allow-same-origin allow-modals allow-popups" id="output"></iframe>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        <!-- // content -->
    </div>
    <!-- // container -->
</div>

<!-- ly_pop_editor_settings -->
<article data-popover-ref="editor_settings" id="lyPopEditorSettings" class="ly_pop ly_pop_editor_settings hidden">
    <div class="ly_pop_header">
        <h1>Editor Settings</h1>
    </div>
    <div class="ly_pop_container">
        <div class="ly_pop_content">
            <section>
                <h2>General</h2>
                <div class="field_cont">
                    <ul>
                        <li>
                            <label class="chk_switch">
                                <input type="checkbox" checked name="lineNumbers">
                                <span class="checkbox"></span>
                                <em>Line numbers</em>
                            </label>
                        </li>
                        <li>
                            <label class="chk_switch">
                                <input type="checkbox" name="lineWrapping">
                                <span class="checkbox"></span>
                                <em>Wrap lines</em>
                            </label>
                        </li>
                        <li>
                            <label class="chk_switch">
                                <input type="checkbox" checked name="indentWithTabs">
                                <span class="checkbox"></span>
                                <em>Indent with tabs</em>
                            </label>
                        </li>
                        <li>
                            <label class="chk_switch">
                                <input type="checkbox" checked name="showHints">
                                <span class="checkbox"></span>
                                <em>Code hinting (autocomplete)</em>
                            </label>
                        </li>
                    </ul>
                    <div class="select_pairs">
                        <div class="select_pair">
                            <label for="indentUnit">Indent size:</label>
                            <select name="indentUnit" id="indentUnit">
                                <option value="2">2 spaces</option>
                                <option value="3">3 spaces</option>
                                <option selected value="4">4 spaces</option>
                            </select>
                        </div>
                        <div class="select_pair">
                            <label for="keyMap">Key map:</label>
                            <select name="keyMap" id="keyMap">
                                <option selected value="default">Default</option>
                                <option value="sublime">Sublime Text</option>
                                <option value="vim">VIM</option>
                                <option value="emacs">EMACS</option>
                            </select>
                        </div>
                        <div class="select_pair">
                            <label for="fontSize">Font size:</label>
                            <select name="fontSize" id="fontSize">
                                <option selected value="default">Default</option>
                                <option value="small">Small</option>
                                <option value="big">Big</option>
                                <option value="bigger">Bigger</option>
                                <option value="jabba">Jabba</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
            <section>
                <h2>Behavior</h2>
                <div class="field_cont">
                    <ul>
                        <li>
                            <label class="chk_switch">
                                <input type="checkbox" checked name="autoCloseTags">
                                <span class="checkbox"></span>
                                <em>Auto-close HTML tags</em>
                            </label>
                        </li>
                        <li>
                            <label class="chk_switch">
                                <input type="checkbox" checked name="matchTags">
                                <span class="checkbox"></span>
                                <em>Highlight matching tags</em>
                            </label>
                        </li>
                    </ul>
                </div>
            </section>
        </div>
    </div>
</article>
<!-- //ly_pop_editor_settings -->
<!-- ly_pop_help -->
<article data-popover-ref="editor_help" id="lyPopEditorHelp" class="ly_pop ly_pop_editor_help hidden">
    <div class="ly_pop_header">
        <h1>Editor Help</h1>
    </div>
    <div class="ly_pop_container">
        <div class="ly_pop_content">
            <section>
                <h2>Keyboard shortcuts</h2>
                <ul>
                    <li>[ctrl] + [enter]: Re-render output.</li>
                </ul>
            </section>
            <section>
                <h2>Send feedback &amp; file bugs</h2>
                <ul>
                    <li><a href="mailto://seungwoonjjang@gmail.com">Developer by woonyzzang.</a></li>
                </ul>
            </section>
        </div>
    </div>
</article>
<!-- //ly_pop_help -->

<script src="./js/libs/jquery-3.3.1.min.js"></script>
<script src="./js/libs/split-1.5.9.min.js"></script>
<script src="./js/libs/codemirror-5.41.0.min.js"></script>
<script src="./js/libs/mode/xml/xml.js"></script><!-- HTML Syntax (필수) -->
<script src="./js/libs/mode/css/css.js"></script><!-- CSS Syntax (필수) -->
<script src="./js/libs/mode/javascript/javascript.js"></script><!-- JavaScript Syntax (필수) -->
<script src="./js/libs/addon/scroll/simplescrollbars.js"></script><!-- 스크롤바 -->
<script src="./js/libs/addon/fold/xml-fold.js"></script><!-- 같은단어 강조(의존성 필수) -->
<script src="./js/libs/addon/edit/matchtags.js"></script><!-- 같은단어 강조 -->
<script src="./js/libs/addon/edit/closetag.js"></script><!-- HTML 닫기 태그 자동 생성 -->
<script src="./js/libs/addon/edit/closebrackets.js"></script><!-- CSS 닫기 중괄호 자동 생성 -->
<script src="./js/libs/addon/hint/show-hint.js"></script><!-- 자동완성 레이어(의존성 필수) -->
<script src="./js/libs/addon/hint/xml-hint.js"></script><!-- XML 자동완성 레이어 -->
<script src="./js/libs/addon/hint/html-hint.js"></script><!-- HTML 자동완성 레이어 -->
<script src="./js/libs/addon/hint/css-hint.js"></script><!-- CSS 자동완성 레이어 -->
<script src="./js/libs/addon/hint/javascript-hint.js"></script><!-- JavaScript 자동완성 레이어 -->
<script src="./js/libs/addon/selection/active-line.js"></script><!-- 커서 활설화 라인 -->
<script src="./js/libs/addon/comment/comment.js"></script><!-- 키맵 주석(의존성 필수) -->
<script src="./js/libs/keymap/sublime.js"></script><!-- sublime 키맵 -->
<script src="./js/libs/keymap/vim.js"></script><!-- vim 키맵 -->
<script src="./js/libs/keymap/emacs.js"></script><!-- emacs 키맵 -->
<script>
;(function(win, doc, $) {
    'use strict';

    function JEditor() {
        /** 생성자 */
        this._constructor = function() {
            this.LOCATION_HOST = 'http://localhost:63342';
            this.COMPONENT_DATA_URL = this.LOCATION_HOST + '/codeMirror/component/data.json';

            this.splitter = null;
            this.codeMirrorEditorHtml = null;
            this.codeMirrorEditorCss = null;
            this.codeMirrorEditorJavaScript = null;

            this._init();
            this.addEvtListener();
        };

        /** output 패널 업데이트 */
        this.updateOutput = function() {
            var outputFrame = document.querySelector('#output'),
                output = outputFrame.contentDocument || outputFrame.contentWindow.document;

            // output 패널 타이틀 영역 노출/숨김
            ($.trim(this.codeMirrorEditorHtml.getValue()).length)? $('#panelOutput>strong').hide() : $('#panelOutput>strong').show();

            output.open();
            output.write('<!DOCTYPE html>');
            output.write('<html>');
            output.write('<head>');
            output.write('<meta charset="utf-8">');
            output.write('<title></title>');
            output.write('<script src="' + this.LOCATION_HOST + '/codeMirror/cdn/libs/jquery-1.10.2.min.js"><\/script>');
            output.write('<script src="' + this.LOCATION_HOST + '/codeMirror/cdn/libs/lodash-3.10.1.min.js"><\/script>');
            // output.write('<script src="http://localhost:63342/codeMirror/cdn/upleat-core-1.0.2.min.js"><\/script>');
            output.write('<script>$.getScript("' + this.LOCATION_HOST + '/codeMirror/cdn/upleat-core-1.0.2.min.js");<\/script>');
            output.write('<script>');
            output.write(this.codeMirrorEditorJavaScript.getValue());
            output.write('<\/script>');
            output.write('<style>');
            output.write(this.codeMirrorEditorCss.getValue());
            output.write('</style>');
            output.write('</head>');
            output.write('<body>');
            output.write(this.codeMirrorEditorHtml.getValue());
            output.write('</body>');
            output.write('</html>');
            output.close();
        };

        /** 이벤트 핸들러 */
        this.addEvtListener = function() {
            var _that = this;
            var delay = 0;

            /*this.codeMirrorEditorHtml.on('change', function() {
                clearTimeout(delay);
                delay = win.setTimeout(function() {
                    _that.updatePreview()
                }, 300);
            });*/

            // Run (실행) 버튼 이벤트 핸들러
            $('#btnRun').on('click', function() {
                clearTimeout(delay);

                delay = win.setTimeout(function() {
                    _that.updateOutput();
                }, 300);
            });

            // 키보드 단축키 이벤트 핸들러
            $(doc).on('keydown', function(e) {
                // 컨트롤 + 엔터 Run (실행)
                if ((e.keyCode === 10 || e.keyCode === 13) && e.ctrlKey) { $('#btnRun').triggerHandler('click'); }
            });

            // 컴포넌트 셀렉트박스 이벤트 핸들러
            $('#component').on('change', function() {
                var $this = $(this);

                switch ($this.children('option:selected').val()) {
                    case 'none':
                        _that.codeMirrorEditorHtml.setValue('');
                        _that.codeMirrorEditorCss.setValue('');
                        _that.codeMirrorEditorJavaScript.setValue('');
                        break;
                    default:
                        $.getJSON(_that.COMPONENT_DATA_URL, function(data) {
                            for (var i = 0, len = data.components.length; i < len; i ++) {
                                if ($this.children('option:selected').val() === data.components[i].module) {
                                    $.when(
                                        $.ajax({
                                            url: data.components[i].url.html,
                                            context: document.body
                                        }),
                                        $.ajax(data.components[i].url.css),
                                        $.ajax(data.components[i].url.javascript)
                                    ).done(function(dataHtml, dataCss, dataJavascript) {
                                        _that.codeMirrorEditorHtml.setValue(dataHtml[0]);
                                        _that.codeMirrorEditorCss.setValue(dataCss[0]);
                                        _that.codeMirrorEditorJavaScript.setValue(dataJavascript[0]);
                                    });
                                }
                            }
                        });
                        break;
                }

                $('#btnRun').triggerHandler('click');
            });

            // 컨트롤 버튼 이벤트 핸들러
            $('#controls').on('click', ':button[type=button]', function() {
                var $controls = $('#controls'),
                    $controlsBtns = $controls.children(':button[type=button]');
                var $this = $(this);
                var dataSizes = _that.splitter.getSizes().slice(); // 배열 복사

                $this.toggleClass('active');

                // 에디터 패널 최소 1개 유지
                if ($controls.children(':button[type=button].active').length < 1) {
                    $this.addClass('active');

                    return;
                }

                // 데이터 사이즈 배열 가공
                for (var i = 0, len = $controlsBtns.length; i < len; i++) {
                    (!$controlsBtns.eq(i).hasClass('active'))? dataSizes[i] = 0 : dataSizes[i] = (100 / $controls.children(':button[type=button].active').length);
                }

                _that.splitter.setSizes(dataSizes);
            });

            // 유틸 메뉴 이벤트 핸들러
            $('#utils').on('click', 'a', function(e) {
                e.preventDefault();

                var $this = $(this),
                    target = $this.data('popoverTrigger');

                $this.toggleClass('active');
                $('[data-popover-ref=' + target + ']').toggleClass('hidden');
            });

            // 레이어팝업 셋팅 옵션 이벤트 핸들러
            $('#lyPopEditorSettings')
                .on('change', '.chk_switch :checkbox', function() {
                    var $this = $(this);

                    switch ($this.attr('name')) {
                        case 'lineNumbers':
                            if ($this.prop('checked')) {
                                _that.codeMirrorEditorHtml.setOption('lineNumbers', true);
                                _that.codeMirrorEditorCss.setOption('lineNumbers', true);
                                _that.codeMirrorEditorJavaScript.setOption('lineNumbers', true);
                            } else {
                                _that.codeMirrorEditorHtml.setOption('lineNumbers', false);
                                _that.codeMirrorEditorCss.setOption('lineNumbers', false);
                                _that.codeMirrorEditorJavaScript.setOption('lineNumbers', false);
                            }
                            break;
                        case 'lineWrapping':
                            if ($this.prop('checked')) {
                                _that.codeMirrorEditorHtml.setOption('lineWrapping', true);
                                _that.codeMirrorEditorCss.setOption('lineWrapping', true);
                                _that.codeMirrorEditorJavaScript.setOption('lineWrapping', true);
                            } else {
                                _that.codeMirrorEditorHtml.setOption('lineWrapping', false);
                                _that.codeMirrorEditorCss.setOption('lineWrapping', false);
                                _that.codeMirrorEditorJavaScript.setOption('lineWrapping', false);
                            }
                            break;
                        case 'indentWithTabs':
                            if ($this.prop('checked')) {
                                _that.codeMirrorEditorHtml.setOption('indentWithTabs', true);
                            } else {
                                _that.codeMirrorEditorHtml.setOption('indentWithTabs', false);
                            }
                            break;
                        case 'showHints':
                            if ($this.prop('checked')) {
                                _that.codeMirrorEditorHtml.setOption('extraKeys', {'Ctrl-J': 'toMatchingTag', 'Ctrl-Space': 'autocomplete'});
                                _that.codeMirrorEditorCss.setOption('extraKeys', {'Ctrl-Space': 'autocomplete'});
                                _that.codeMirrorEditorJavaScript.setOption('extraKeys', {'Ctrl-Space': 'autocomplete'});
                            } else {
                                _that.codeMirrorEditorHtml.setOption('extraKeys', {'Ctrl-J': 'toMatchingTag', 'Ctrl-Space': ''});
                                _that.codeMirrorEditorCss.setOption('extraKeys', {'Ctrl-Space': ''});
                                _that.codeMirrorEditorJavaScript.setOption('extraKeys', {'Ctrl-Space': ''});
                            }
                            break;
                        case 'autoCloseTags':
                            if ($this.prop('checked')) {
                                _that.codeMirrorEditorHtml.setOption('autoCloseTags', true);
                            } else {
                                _that.codeMirrorEditorHtml.setOption('autoCloseTags', false);
                            }
                            break;
                        case 'matchTags':
                            if ($this.prop('checked')) {
                                _that.codeMirrorEditorHtml.setOption('matchTags', true);
                            } else {
                                _that.codeMirrorEditorHtml.setOption('matchTags', false);
                            }
                            break;
                    }
                })
                .on('change', '.select_pairs select', function() {
                    var $this = $(this);

                    switch ($this.attr('name')) {
                        case 'indentUnit':
                            _that.codeMirrorEditorHtml.setOption('tabSize', $this.children('option:selected').val());
                            _that.codeMirrorEditorCss.setOption('tabSize', $this.children('option:selected').val());
                            _that.codeMirrorEditorJavaScript.setOption('tabSize', $this.children('option:selected').val());
                            break;
                        case 'keyMap':
                            _that.codeMirrorEditorHtml.setOption('keyMap', $this.children('option:selected').val());
                            _that.codeMirrorEditorCss.setOption('keyMap', $this.children('option:selected').val());
                            _that.codeMirrorEditorJavaScript.setOption('keyMap', $this.children('option:selected').val());
                            break;
                        case 'fontSize':
                            $('#splitter').find('.editbox').removeClass('default small big jabba bigger').addClass($this.children('option:selected').val());
                            break;
                    }

                    $this
                        .children('option:eq(' + $this.children('option:selected').index() + ')').prop('selected', true).attr('selected', true)
                        .siblings('option').prop('selected', false).attr('selected', false);
                });

            /* [T] 셀렉트박스 강제 열기
            $('label[for=componenet]').on('click', function() {
                $('#componenet')[0].size = 6;
                $('#componenet').focus().show();
            });*/
        };

        /** 컴포넌트 셀렉트박스 초기 렌더 */
        this.componentRender = function() {
            var $docFragment = $(document.createDocumentFragment());

            // 첫글자 대문자로 변환
            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            $docFragment.append('<option value="none">none</option>');

            $.getJSON(this.COMPONENT_DATA_URL, function(data) {
                for (var i = 0, len = data.components.length; i < len; i ++) {
                    $docFragment.append('<option title="' + data.components[i].author + '" value="'+ data.components[i].module +'">' + capitalizeFirstLetter(data.components[i].module) + ' - ' + data.components[i].version + '</option>');
                }

                $('#component').append($docFragment);
            });
        };

        /** 코어 관련 비동기 JS 로드 */
        this.asyncLoadJS = function() {
            $.getScript(this.LOCATION_HOST + '/codeMirror/cdn/libs/lodash-3.10.1.min.js');
            $.getScript(this.LOCATION_HOST + '/codeMirror/cdn/upleat-core-1.0.2.min.js');
        };

        /** 초기화 */
        this._init = function() {
            var _that = this;

            this.componentRender();
            this.asyncLoadJS();

            this.splitter = Split(['#panelHtml', '#panelCss', '#panelJavascript', '#panelOutput'], {
                sizes: [25, 25, 25, 25],
                gutterSize: 4,
                minSize: 0
                // direction: 'vertical',
                // onDragEnd: function(sizes) {
                //     localStorage.setItem('split-sizes', JSON.stringify(sizes))
                // }
            });

            /*var split = Split(['#panelHtml', '#panelCss', '#panelJavascript', '#panelOutput'], {
                elementStyle: function(dimension, size, gutterSize) {
                    return {
                        'flex-basis': 'calc(' + size + '% - ' + gutterSize + 'px)',
                    }
                },
                gutterStyle: function(dimension, gutterSize) {
                    return {
                        'flex-basis': gutterSize + 'px',
                    }
                },
            });*/

            this.codeMirrorEditorHtml = CodeMirror.fromTextArea(document.querySelector('#html'), {
                mode: 'text/html', // 문서타입
                theme: 'monokai', // 테마
                scrollbarStyle: 'simple', // 스크롤바 스타일
                smartIndent: false, // 자동 들여쓰기
                tabSize: 4, // 탭 간격
                indentWithTabs: true, // 들여 쓰기 할 때 첫 번째 N * tabSize 공백을 N 탭으로 바꿔야 하는지 여부
                // readOnly: true, // 쓰기 방지
                lineWrapping: false, // 가로 스크롤바 숨김, 너비에 맞게 줄바꿈.
                lineNumbers: true, // 라인넘버 표시
                // fixedGutter: false,
                styleActiveLine: true, // 코드 셀렉트라인 활성화
                // styleActiveSelected: true,
                matchTags: {bothTags: true}, // 시작, 종료 태그 하이라이트
                autoCloseTags: true, // 자동 닫기 태그 생성
                keyMap: 'default',
                extraKeys: {'Ctrl-J': 'toMatchingTag', 'Ctrl-Space': 'autocomplete'} // 코드 힌트
            });

            this.codeMirrorEditorCss = CodeMirror.fromTextArea(document.querySelector('#css'), {
                mode: 'text/css',
                theme: 'monokai',
                scrollbarStyle: 'simple',
                smartIndent: false,
                tabSize: 4,
                lineWrapping: false,
                lineNumbers: true,
                styleActiveLine: true,
                autoCloseBrackets: true, // 자동 중괄호 생성
                keyMap: 'default',
                extraKeys: {'Ctrl-Space': 'autocomplete'}
            });

            this.codeMirrorEditorJavaScript = CodeMirror.fromTextArea(document.querySelector('#javascript'), {
                mode: 'text/javascript',
                theme: 'monokai',
                scrollbarStyle: 'simple',
                tabSize: 4,
                lineWrapping: false,
                lineNumbers: true,
                styleActiveLine: true,
                keyMap: 'default',
                extraKeys: {'Ctrl-Space': 'autocomplete'}
            });

            win.setTimeout(function() {
                _that.updateOutput();
            }, 300);
        };

        this._constructor();
    }

    var jEditor = new JEditor();
})(window, document, jQuery);
</script>
</body>
</html>